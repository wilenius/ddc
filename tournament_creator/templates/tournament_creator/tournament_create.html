{% extends 'tournament_creator/base.html' %}

{% block title %}Create Tournament - DDC Tournament Manager{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 offset-md-2">
        <h2>Create New Tournament</h2>
        <form method="post">
            {% csrf_token %}
            <div class="card mb-4">
                <div class="card-header">
                    Tournament Settings
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Tournament Name</label>
                        <input type="text" name="name" class="form-control" required value="{{ request.GET.name|default:'' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tournament Date</label>
                        <input type="date" name="date" class="form-control" required value="{{ request.GET.date|default:'' }}">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Tournament Type</label>
                        <select name="archetype" id="archetype-select" class="form-select" required>
                            <option value="">Select a tournament type</option>
                            {% for archetype in archetypes %}
                                <option value="{{ archetype.id }}" {% if archetype.id|stringformat:'s' == request.GET.archetype %}selected{% endif %}>{{ archetype.name }}</option>
                            {% endfor %}
                        </select>
                        <script>
document.addEventListener('DOMContentLoaded', function() {
    var select = document.getElementById('archetype-select');
    select.addEventListener('change', function() {
        // Collect form values
        var name = document.querySelector('input[name="name"]').value;
        var date = document.querySelector('input[name="date"]').value;
        var url = "{% url 'tournament_create' %}?archetype=" + this.value +
                  "&name=" + encodeURIComponent(name) +
                  "&date=" + encodeURIComponent(date);
        window.location = url;
    });
});
</script>
                    </div>
                </div>
            </div>

            {% if archetype and archetype.tournament_category == "MOC" %}
                <div class="card mb-4">
                    <div class="card-header">Select Players</div>
                    <div class="card-body">
                        <div class="mb-3">
                            {{ moc_player_form.players }}
                        </div>
                    </div>
                </div>
                <script>
                    $(document).ready(function() {
                        console.log("Tournament create page ready");
                        console.log("Player select field:", $("#id_players"));
                        
                        // Ensure Select2 is initialized on the players field
                        try {
                            $("#id_players").select2({
                                width: '100%',
                                ajax: {
                                    url: "{% url 'player-autocomplete' %}",
                                    dataType: 'json',
                                    delay: 250,
                                    data: function (params) {
                                        // Get current selected values to exclude from results
                                        var selectedValues = $("#id_players").val() || [];
                                        console.log("Selected values in data function:", selectedValues);
                                        
                                        return {
                                            q: params.term, // search term
                                            page: params.page,
                                            selected: selectedValues // pass currently selected players
                                        };
                                    },
                                    processResults: function (data, params) {
                                        console.log("Custom processResults:", data);
                                        params.page = params.page || 1;
                                        
                                        // Get current selected values
                                        var selectedValues = $("#id_players").val() || [];
                                        
                                        // Additional client-side filtering to remove any already selected players
                                        if (selectedValues.length > 0) {
                                            data.results = data.results.filter(function(player) {
                                                return !selectedValues.includes(player.id);
                                            });
                                        }
                                        
                                        return {
                                            results: data.results,
                                            pagination: data.pagination
                                        };
                                    },
                                    cache: false // Disable caching to ensure fresh results each time
                                },
                                minimumInputLength: 1,
                                templateResult: function(item) {
                                    return item.text;
                                },
                                templateSelection: function(item) {
                                    return item.text;
                                }
                            });
                            
                            // Update dropdown when selection changes
                            $("#id_players").on("change", function() {
                                // This will force select2 to reevaluate the results with the new selection
                                $(this).select2("close");
                            });
                            
                            // Force empty initial request to load default values
                            $.ajax({
                                url: "{% url 'player-autocomplete' %}",
                                data: {
                                    selected: $("#id_players").val() || []
                                },
                                dataType: 'json',
                                headers: {
                                    'X-CSRFToken': "{{ csrf_token }}",
                                    'X-Requested-With': 'XMLHttpRequest'
                                },
                                success: function(data) {
                                    console.log("Initial player load:", data);
                                },
                                error: function(xhr, status, error) {
                                    console.error("Initial player load error:", error);
                                }
                            });
                            
                            console.log("Select2 player selector successfully initialized");
                        } catch (e) {
                            console.error("Error initializing Select2:", e);
                        }
                    });
                </script>
            {% endif %}
            <div class="text-center">
                <button type="submit" class="btn btn-primary">Create Tournament</button>
                <a href="{% url 'tournament_list' %}" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>
{% endblock %}